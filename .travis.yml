sudo: false
dist: trusty

language: python

python:
  - "3.6"

addons:
  apt:
    update: true
    packages:
      # needed for pyenchant, needed for sphinx-spellcheck
      - libenchant-dev

env:
  global:
    # https://docs.travis-ci.com/user/encryption-keys/

    - secure: "bhd4WT327gtt8Q73ZhKK08hfurSDo6zk8z1nmorQAGKC3EFtuCDeIz+zRp7011CvuIpFhWsuqqAxbpbNGEO6sp8nm/cdLRf/bCG3lKSndYAJew02OU7eAweJNaRfAROkxEnmRHdwaIZB5p62fARjfLj+/Bxr+cIj7GCSuY9XoqX/ozIhVFUl+ypQRrOGkfdsreCkivp3TglTB2wSp23/2o0E6iO4AjTvQHDEQhZ9VNqcMrk4wR0KQ5e0aPdEguRfZzpxUTluU6nTeDknGT/Va7SmLtdjFE/ViAi1XYyMvCMyhtAhhIgghK9OYnDJq422AtVHskTexPG5UjZnN24kl86g4KWweObqZoQQCfpttBh3u1hmw56/LFdqRZtu6ji9wxm0xlr7vCM6G1q742JJHyNiMZFdqybszD3BcLWUGWsnP9o3FhFsU34YrANtus1wCqolaETy20axs81xKSh1/PDHVXVRvndIYPnloJIcTeUiYGW1ysRltfKkXQiQ1Vi/2spAks2Pt7zXpuQv2aLG3Rdjwv8DLVpQZtSk2Q43pjSTlcxnH64Aml/n8XBwjMHsKw5jdM38Oi9lf69vKeDEiDvFdbCn2ZobC2audJ2LAVVm+A+NNYiGdgz1DP9hSCIS2d1EIn3uOC04WDVxG3+tq7RZbNSDjCe1vBQHobS+rDM="
    - secure: "DgYuXkAQnk5UoqshMSTFwErpndRa95TgNyXoj+VmlUdGhuQ9Nqlmy6fRKciZPciY6UKpp83/32RTE/ESH9c48Rfk2JH8exRS3FQL5AwFRBWjdiv4JSYVmBsDe7sqdbZEu7ohhDtY6lBquNxszG0DgbwmctrNRM2QTxrDD5nfMfykcbRnk3z6SdF2J8tYjGXZL9WlrOM1Jg7utQzmKswvfKijoZQ6wd9R9KcAa3gO69qZ/wEELu+xF0iS3Y5Y9za7cd5bvj7ho0Zykx970pjQbqnQfD0OoT69JA2gXNFfC7ppj0y6cmjQEDTit9seF16RzS09U9BD9dAdNFg+hCGO2N3LDhnxv49qBijvRL5iUcM68CistIMsXluBjAFf7SPVCfJVpJWkwswInK19+Iv0UZUtBXGOWK4O0zi+9TGHhM5M2+tQylBM56AZ/Wg4vaQTijBaRgSMRmnTkCCGxPFX1VfUBkD9VlgYEinfkxD9N3hzi3wcSSrSOTwMtzromNn3JOCAUWZihduHDit1IHd0dquoF1K3F8bQAksZ/XH0MokryK04Ft5QCWbT6R9+3+wqRgqbWiz8hnMpqobarTH7cZZ0LseSyl5+rzYqk6kDb/cJFbNsNNBKynlh0F4couXGrmKeBm+1WPC0K0U+CN05LyemIa16SQWoqoqvDgbUSI4="

    # Company AWS S3 bucket where we upload artifacts
    - AWS_DEFAULT_REGION: "eu-west-1"
    - AWS_S3_BUCKET_NAME: "crossbar.io"

before_install:
  # only show number of env vars .. should be 4!
  - sh -c 'env | grep AWS | wc -l'

  # set up awscli package
  - pip install awscli
  - export PATH=$PATH:$HOME/.local/bin
  - which aws
  - aws --version
  - aws s3 ls ${AWS_S3_BUCKET_NAME}

  # build ID (eg, "20180513-28114a1")
  - export CROSSBAR_BUILD_ID="$(date --utc "+%Y%m%d")-$(git rev-parse --short ${TRAVIS_COMMIT})"

install:
  - pip install -U pip setuptools wheel tox codecov

script:
  - tox -c tox.ini -e $TOX_ENV

cache:
  directories:
    - $HOME/.cache/pip

matrix:
  fast_finish: true

  include:
    - python: 3.6
      env: TOX_ENV=sphinx

    # - python: 3.6
    #   env: TOX_ENV=flake8

    # - python: 3.6
    #   env: TOX_ENV=bandit

    # - python: 3.6
    #   env: TOX_ENV=coverage

    # - python: 3.6
    #   env: TOX_ENV=py36-cli
    # - python: pypy3
    #   env: TOX_ENV=pypy3-cli

    # - python: 3.6
    #   env: TOX_ENV=py36-examples
    # - python: pypy3
    #   env: TOX_ENV=pypy3-examples

    # - python: 3.6
    #   env: TOX_ENV=py36-unpinned-trial
    # - python: 3.6
    #   env: TOX_ENV=py36-pinned-trial
    # - python: 3.6
    #   env: TOX_ENV=py36-abtrunk-trial

    # - python: pypy3
    #   env: TOX_ENV=pypy3-unpinned-trial
    # - python: pypy3
    #   env: TOX_ENV=pypy3-pinned-trial
    # - python: pypy3
    #   env: TOX_ENV=pypy3-abtrunk-trial

    # https://docs.travis-ci.com/user/build-stages/matrix-expansion/
    - stage: deploy
      python: "3.6"
      on:
        repo: crossbario/crossbar
        branch: master
        # tags: true
      skip_cleanup: true
      provider: script
      script: pwd && ls -la && sh .travis-deploy.sh

      # It is important to note that jobs do not share storage, as each job runs in a fresh VM or container.
      # If your jobs need to share files (e.g., using build artifacts from the “Test” stage for deployment
      # in the subsequent “Deploy” stage), you need to use an external storage mechanism such as
      # S3 and a remote scp server.
      #
      # https://docs.travis-ci.com/user/build-stages/#Data-persistence-between-stages-and-jobs

  # we allow failures when not using autobahn trunk, for cases
  # where we depend on a new feature in autobahn here in crossbar
  allow_failures:
    - python: 3.6
      env: TOX_ENV=py36-unpinned-trial
    - python: 3.6
      env: TOX_ENV=py36-pinned-trial

    - python: pypy3
      env: TOX_ENV=pypy3-unpinned-trial
    - python: pypy3
      env: TOX_ENV=pypy3-pinned-trial

after_success:
  - codecov

# CI notifications
notifications:
  # IRC: chat messages on #crossbar-ci @ freenode
  irc:
    on_success: always  # options: [always|never|change] default: always
    on_failure: always  # options: [always|never|change] default: always
    on_start: always    # options: [always|never|change] default: always
    channels:
      - "irc.freenode.org#crossbar-ci"
    use_notice: false
    skip_join: false

  # Gitter: activity feed on https://gitter.im/crossbario/ci
  webhooks:
    on_success: always  # options: [always|never|change] default: always
    on_failure: always  # options: [always|never|change] default: always
    on_start: always    # options: [always|never|change] default: always
    urls:
      # travis encrypt --org --repo crossbario/crossbar "https://webhooks.gitter.im/e/7ef..."
      - secure: "Wgw066oYjEUmkD2z8uVUcz/yTF8Iz+vQX/XRPobN/Jq8Fxv4i9NYWrAbZ7iEDZxYWhZk95BtBbI0MkhHj49cr1ijxqkyikH6gucZRtQTyBEZHmbMwAHnZEND0PuzFFOZwTRftcqauc/UHOQN8W/BO5bd53tyS4eCGV5QE8FDhhM="

  # Slack: post feed on https://crossbario.slack.com/ in channel #ci
  slack:
    on_success: always  # options: [always|never|change] default: always
    on_failure: always  # options: [always|never|change] default: always
    on_start: always    # options: [always|never|change] default: always
    rooms:
      # travis encrypt --org --repo crossbario/crossbar "crossbario:FYg..."
      - secure: "lH4zZ30xaRyPlI9kixw8r8vnYTypbh4/ogN4xbK4c3UOZilEJqFZG08OpMZJUUfIBJpMQLgCevJmXEiYqDh9gr7crPiFV1yWU7+RXrLRRh/EQniv/zMF5JaNkRr6xcoifcvLg2jx043W+zUKAnJshV8Aikn06OZGPOa1tvFJmC0="
